<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xác nhận Đơn hàng - LANCHI MART</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    .header-banner { background-color: #e30019; }
    .toast { display: none; position: fixed; bottom: 20px; right: 20px; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; z-index: 1050; font-size: 17px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    .toast.success { background-color: #4CAF50; }
    .toast.error { background-color: #f44336; }
    .order-summary-table th, .order-summary-table td {
        padding: 0.75rem; text-align: left;
        border-bottom: 1px solid #e5e7eb; /* gray-200 */
    }
    .order-summary-table th {
        background-color: #f9fafb; /* gray-50 */ font-weight: 600;
        font-size: 0.75rem; /* text-xs */ text-transform: uppercase;
        letter-spacing: 0.05em; color: #4b5563; /* gray-600 */
    }
    .order-summary-table img {
        width: 4rem; /* w-16 */ height: 4rem; /* h-16 */
        object-fit: cover; border-radius: 0.25rem; /* rounded-sm */
        margin-right: 1rem;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<header class="bg-white shadow-md sticky top-0 z-50">
  <div class="container mx-auto px-4">
    <div class="flex flex-col md:flex-row justify-between items-center py-3">
      <div class="flex items-center">
        <a href="/" class="flex items-center text-2xl font-bold text-red-600">
          <img src="https://cdn-001.haui.edu.vn//img/logo-haui-size.png" alt="LANCHI MART Logo" class="h-10 mr-2">
        </a>
      </div>
      <div class="flex items-center space-x-3 sm:space-x-4">
        <div id="userAuthStatusHeader" class="text-sm flex items-center">
          <a href="/login" class="text-gray-700 hover:text-red-600">Đăng nhập</a>
        </div>
        <a href="/cart" id="cartIconHeader" class="relative text-gray-700 hover:text-red-600">
          <i class="fas fa-shopping-cart fa-lg"></i>
          <span id="cartItemCountHeader" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-semibold">0</span>
        </a>
      </div>
    </div>
  </div>
</header>

<div class="container mx-auto px-2 sm:px-4 mt-6 mb-8">
  <div id="orderConfirmationContent" class="bg-white p-6 md:p-8 rounded-lg shadow-lg max-w-3xl mx-auto">
    <div id="confirmationLoadingMessage" class="text-center py-10 text-gray-500">
      <i class="fas fa-spinner fa-spin fa-2x"></i>
      <p class="mt-2">Đang tải thông tin đơn hàng...</p>
    </div>

    <div id="confirmationDetails" class="hidden">
      <div class="text-center mb-8">
        <i class="fas fa-check-circle fa-4x text-green-500 mb-3"></i>
        <h1 class="text-3xl font-bold text-green-600">Đặt Hàng Thành Công!</h1>
        <p class="text-gray-600 mt-2">Cảm ơn bạn đã mua sắm tại LANCHI MART. Đơn hàng của bạn đang được xử lý.</p>
      </div>

      <div class="border-b pb-4 mb-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-3">Thông Tin Đơn Hàng</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 text-sm">
          <div><strong>Mã đơn hàng:</strong> <span id="confOrderId" class="text-red-600 font-medium"></span></div>
          <div><strong>Ngày đặt:</strong> <span id="confOrderDate"></span></div>
          <div><strong>Trạng thái:</strong> <span id="confOrderStatus" class="font-medium"></span></div>
          <div><strong>Tổng tiền:</strong> <span id="confOrderTotal" class="font-bold text-red-600"></span></div>
        </div>
      </div>

      <div class="mb-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-3">Thông Tin Người Nhận</h2>
        <div class="text-sm space-y-1">
          <p><strong>Tên người nhận:</strong> <span id="confCustomerName"></span></p>
          <p><strong>Số điện thoại:</strong> <span id="confCustomerPhone"></span></p>
          <p id="confCustomerEmailContainer" class="hidden"><strong>Email:</strong> <span id="confCustomerEmail"></span></p>
          <p><strong>Địa chỉ giao hàng:</strong> <span id="confShippingAddress"></span></p>
          <p id="confOrderTitleContainer" class="hidden"><strong>Ghi chú:</strong> <span id="confOrderTitle" class="italic text-gray-600"></span></p>
        </div>
      </div>

      <div>
        <h2 class="text-xl font-semibold text-gray-700 mb-3">Chi Tiết Sản Phẩm</h2>
        <div class="overflow-x-auto">
          <table class="w-full order-summary-table">
            <thead>
            <tr>
              <th>Sản phẩm</th>
              <th class="text-center">Số lượng</th>
              <th class="text-right">Đơn giá</th>
              <th class="text-right">Thành tiền</th>
            </tr>
            </thead>
            <tbody id="confOrderItemsContainer">
            <!-- Chi tiết sản phẩm sẽ được render ở đây -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="mt-8 text-center">
        <a href="/" class="inline-block bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-6 rounded-md transition-colors mr-3">
          <i class="fas fa-home mr-2"></i>Tiếp tục mua sắm
        </a>
        <a href="/orders/my-history" id="viewOrderHistoryBtn" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-md transition-colors">
          <i class="fas fa-history mr-2"></i>Xem lịch sử đơn hàng
        </a>
      </div>
    </div>
    <div id="orderNotFoundError" class="hidden text-center py-10">
      <i class="fas fa-exclamation-circle fa-3x text-red-500 mb-3"></i>
      <p class="text-red-600 text-lg">Không tìm thấy thông tin đơn hàng hoặc bạn không có quyền truy cập.</p>
      <a href="/" class="mt-4 inline-block bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-md transition-colors">
        Về trang chủ
      </a>
    </div>
  </div>
</div>

<footer class="bg-gray-800 text-white py-8 mt-10 text-sm">
  <div class="container mx-auto px-4 text-center">
    <p>&copy; 2025 LANCHI MART - Niềm tin của mọi nhà. Phát triển bởi Nhóm 17.</p>
  </div>
</footer>
<div id="toast" class="toast"><span id="toastMessage"></span></div>

<script>
    // URLs API
    const API_CART_URL = '/api/v1/cart';
    const API_ORDER_URL = '/api/v1/orders';

    // DOM Elements
    let userAuthStatusHeaderEl, cartItemCountHeaderEl, toast, toastMessage,
        checkoutLoadingMessageEl, checkoutFormEl,
        checkoutOrderSummaryItemsEl, summaryTotalQuantityCheckoutEl,
        summarySubtotalCheckoutEl, summaryGrandTotalCheckoutEl,
        placeOrderButtonEl, checkoutFormMessageEl, guestInfoMessageEl;

    // Input elements
    let customerNameInput, customerPhoneInput, customerEmailInput,
        addressNumberInput, addressStreetInput, addressWardInput, addressDistrictInput, addressCityInput, orderTitleInput;

    // Error message elements (for client-side validation)
    let customerNameErrorEl, customerPhoneErrorEl, customerEmailErrorEl,
        addressNumberErrorEl, addressStreetErrorEl, addressWardErrorEl, addressDistrictErrorEl, addressCityErrorEl;


    // --- Quản lý Token & Guest Cart ID ---
    function getToken() { return localStorage.getItem('accessToken'); }
    function getGuestCartId() { return localStorage.getItem('guestCartId'); }
    function setGuestCartId(id) { localStorage.setItem('guestCartId', id); }
    function removeToken() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('loggedInUser');
        console.log("Token và thông tin người dùng đã được xóa.");
    }
    function getLoggedInUser() {
        const userData = localStorage.getItem('loggedInUser');
        try { return userData ? JSON.parse(userData) : null; }
        catch (e) { console.error("Lỗi phân tích loggedInUser từ localStorage:", e); return null; }
    }
    function removeGuestCartId() {
        localStorage.removeItem('guestCartId');
        console.log("GuestCartId đã được xóa.");
    }

    // --- Hàm Tiện ích ---
    function showToast(message, isSuccess = true) {
        if (!toast || !toastMessage) { console.warn("Không tìm thấy phần tử toast:", message); return; }
        toastMessage.textContent = message;
        toast.className = `toast ${isSuccess ? 'success' : 'error'}`;
        toast.style.display = 'block';
        setTimeout(() => { if(toast) toast.style.display = 'none'; }, 3000);
    }
    function formatPrice(price) {
        const numericPrice = Number(price);
        if (price == null || isNaN(numericPrice)) { return '0 ₫'; }
        return numericPrice.toLocaleString('vi-VN') + ' ₫';
    }

    function displayError(element, message) {
        if (element) {
            element.textContent = message;
            element.style.display = message ? 'block' : 'none';
        }
    }

    function clearErrors() {
        displayError(customerNameErrorEl, '');
        displayError(customerPhoneErrorEl, '');
        displayError(customerEmailErrorEl, '');
        displayError(addressNumberErrorEl, '');
        displayError(addressStreetErrorEl, '');
        displayError(addressWardErrorEl, '');
        displayError(addressDistrictErrorEl, '');
        displayError(addressCityErrorEl, '');
        if (checkoutFormMessageEl) checkoutFormMessageEl.textContent = '';
    }

    // --- Hàm Gọi API Chung (Sửa đổi để xử lý guestCartId tốt hơn) ---
    async function makeApiCall(url, method = 'GET', body = null, requiresAuth = false) {
        const headers = { 'Content-Type': 'application/json' };
        const token = getToken();
        let finalUrl = url;

        if (requiresAuth) { // Nếu API yêu cầu xác thực rõ ràng
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            } else {
                console.warn(`Calling API ${url} requires authentication but no token found.`);
                showToast('Vui lòng đăng nhập để thực hiện hành động này.', false);
                localStorage.setItem('redirectAfterLogin', window.location.pathname + window.location.search);
                window.location.href = '/login';
                return Promise.reject({ error: 'NO_TOKEN', status: 401, ok: false, message: "Yêu cầu đăng nhập" });
            }
        } else if (url.startsWith(API_CART_URL)) { // Đối với API giỏ hàng (có thể là khách hoặc người dùng)
            if (token) { // Nếu có token, ưu tiên dùng token
                headers['Authorization'] = `Bearer ${token}`;
            } else { // Nếu không có token, dùng guestCartId
                let guestId = getGuestCartId();
                if (!guestId && !url.includes('/add') && method === 'GET') {
                    guestId = crypto.randomUUID();
                    setGuestCartId(guestId);
                    console.log("Generated new guestCartId:", guestId);
                }
                if (guestId) {
                    finalUrl += (finalUrl.includes('?') ? '&' : '?') + `guestCartId=${guestId}`;
                }
            }
        } else if (token) { // <<< SỬA LỖI: Đây là mấu chốt.
            // Ngay cả khi 'requiresAuth' là false (như API đặt hàng),
            // chúng ta VẪN GỬI token nếu có.
            headers['Authorization'] = `Bearer ${token}`;
        }

        const config = { method: method, headers: headers };
        if (body && (method === 'POST' || method === 'PATCH' || method === 'PUT')) {
            config.body = JSON.stringify(body);
        }
        console.log(`CheckoutPage - Calling API: ${method} ${finalUrl}`, config.body ? `with body: ${config.body.substring(0,150)}...` : '');
        const response = await fetch(finalUrl, config);

        console.log(`CheckoutPage - Raw response from ${finalUrl} - Status: ${response.status}, Content-Type: ${response.headers.get('Content-Type')}`);

        if ((response.status === 401 || response.status === 403) && token) { // Chỉ xử lý 401/403 nếu đã GỬI token
            const message = response.status === 401 ? 'Phiên đăng nhập không hợp lệ hoặc đã hết hạn.' : 'Bạn không có quyền thực hiện hành động này.';
            showToast(message, false);
            if (response.status === 401) {
                removeToken(); removeGuestCartId(); updateUserAuthStatusOnHeader();
                localStorage.setItem('redirectAfterLogin', window.location.pathname + window.location.search);
                window.location.href = '/login';
            }
            throw new Error(response.status === 401 ? 'Unauthorized' : 'Forbidden');
        }
        if (!response.ok) {
            let errorMsg = `Lỗi server (${response.status})`;
            try {
                const errorData = await response.json();
                errorMsg = errorData.message || errorData.error || errorMsg;
            } catch (e) {
                errorMsg = await response.text();
            }
            throw new Error(errorMsg);
        }
        return response;
    }

    // --- Load Cart Summary for Checkout Page ---
    async function loadCartSummaryForCheckout() {
        if (checkoutLoadingMessageEl) checkoutLoadingMessageEl.style.display = 'block';
        if (checkoutFormEl) checkoutFormEl.classList.add('hidden');
        if (placeOrderButtonEl) placeOrderButtonEl.disabled = true;

        try {
            const response = await makeApiCall(API_CART_URL, 'GET', null, false);
            if (response.error === 'NO_TOKEN') { renderCheckoutSummary(null); return; }

            if (!response.ok) {
                let errorMsg = `Lỗi tải tóm tắt giỏ hàng (${response.status})`;
                try {
                    if (response.headers.get("content-type")?.includes("application/json")) {
                         const errorData = await response.json(); errorMsg = errorData.message || errorMsg;
                    } else { errorMsg = await response.text(); }
                } catch (e) {}
                throw new Error(errorMsg);
            }
            const responseData = await response.json();
            if (responseData.status === 200 && responseData.data) {
                renderCheckoutSummary(responseData.data);
            } else {
                throw new Error(responseData.message || "Không thể tải dữ liệu tóm tắt giỏ hàng.");
            }
        } catch (error) {
            if (error.message !== 'Unauthorized' && error.message !== 'Forbidden') {
                console.error("Lỗi khi tải tóm tắt giỏ hàng:", error);
                showToast(`Lỗi tải tóm tắt giỏ hàng: ${error.message}`, false);
                renderCheckoutSummary(null);
            }
        } finally {
            if (checkoutLoadingMessageEl) checkoutLoadingMessageEl.style.display = 'none';
            if (checkoutFormEl) checkoutFormEl.classList.remove('hidden');
        }
    }

    function renderCheckoutSummary(cartData) {
        if (!checkoutOrderSummaryItemsEl || !summaryTotalQuantityCheckoutEl || !summarySubtotalCheckoutEl || !summaryGrandTotalCheckoutEl || !cartItemCountHeaderEl) {
            console.error("Một hoặc nhiều phần tử DOM của tóm tắt đơn hàng không tìm thấy."); return;
        }
        console.log("CheckoutPage - Rendering checkout summary with cartData:", JSON.stringify(cartData, null, 2));

        if (!cartData || !cartData.items || cartData.items.length === 0) {
            checkoutOrderSummaryItemsEl.innerHTML = '<p class="text-gray-500 text-sm py-4 text-center">Giỏ hàng của bạn trống.</p>';
            summaryTotalQuantityCheckoutEl.textContent = '0';
            summarySubtotalCheckoutEl.textContent = '0 ₫';
            summaryGrandTotalCheckoutEl.textContent = '0 ₫';
            cartItemCountHeaderEl.textContent = '0';
            if (placeOrderButtonEl) placeOrderButtonEl.disabled = true;
            showToast("Giỏ hàng trống, không thể thanh toán. Vui lòng thêm sản phẩm.", false);
            setTimeout(() => { window.location.href = '/cart'; }, 2000);
            return;
        }

        checkoutOrderSummaryItemsEl.innerHTML = '';
        cartData.items.forEach(item => {
            const itemHtml = `
                <div class="flex justify-between items-center text-sm py-1 border-b border-gray-200 last:border-b-0">
                    <div class="flex items-center">
                        <img src="${item.productImageUrl || 'https://placehold.co/40x40'}" alt="${item.productName}" class="w-10 h-10 object-cover rounded mr-2">
                        <span class="truncate w-40" title="${item.productName}">${item.productName} (x${item.quantity})</span>
                    </div>
                    <span class="font-medium">${formatPrice(item.lineTotal)}</span>
                </div>
            `;
            checkoutOrderSummaryItemsEl.insertAdjacentHTML('beforeend', itemHtml);
        });

        summaryTotalQuantityCheckoutEl.textContent = cartData.totalQuantity || 0;
        summarySubtotalCheckoutEl.textContent = formatPrice(cartData.subtotalPrice);
        summaryGrandTotalCheckoutEl.textContent = formatPrice(cartData.subtotalPrice);
        cartItemCountHeaderEl.textContent = cartData.totalQuantity || 0;
        if (placeOrderButtonEl) placeOrderButtonEl.disabled = false;
    }

    // --- Pre-fill Form for Logged-in User ---
    function prefillShippingForm() {
        const user = getLoggedInUser();
        if (user && checkoutFormEl) {
            if (customerNameInput && (user.firstName || user.lastName)) {
                customerNameInput.value = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            }
            if (customerPhoneInput && user.phone) {
                customerPhoneInput.value = String(user.phone);
            }
            if (customerEmailInput && user.email) {
                customerEmailInput.value = user.email;
            }
            if(guestInfoMessageEl) guestInfoMessageEl.classList.add('hidden');
        } else if (guestInfoMessageEl) {
            guestInfoMessageEl.classList.remove('hidden');
            const loginLink = document.getElementById('loginLinkFromCheckout');
            const registerLink = document.getElementById('registerLinkFromCheckout');
            const redirectParam = `?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
            if(loginLink) loginLink.href = `/login${redirectParam}`;
            if(registerLink) registerLink.href = `/login${redirectParam}`;
        }
    }

    // --- Handle Place Order ---
    // (Đoạn này đã được di chuyển vào DOMContentLoaded bên dưới)

    // --- Cập nhật trạng thái đăng nhập trên UI Header ---
    function updateUserAuthStatusOnHeader() {
        const user = getLoggedInUser();
        if (userAuthStatusHeaderEl) {
            if (user && (user.userName || user.firstName)) {
                const displayName = user.userName || `${user.firstName || ''} ${user.lastName || ''}`.trim();
                userAuthStatusHeaderEl.innerHTML = `
                    <span class="text-gray-700 mr-2">Chào, ${displayName}!</span>
                    <a href="#" id="logoutLinkCheckoutPage" class="text-red-600 hover:underline font-semibold">Đăng xuất</a>
                `;
                const logoutLink = document.getElementById('logoutLinkCheckoutPage');
                if (logoutLink && !logoutLink.hasLogoutListener) {
                    logoutLink.addEventListener('click', (e) => {
                        e.preventDefault(); removeToken(); removeGuestCartId();
                        showToast('Bạn đã đăng xuất.', true);
                        updateUserAuthStatusOnHeader();
                        window.location.href = '/';
                    });
                    logoutLink.hasLogoutListener = true;
                }
            } else {
                userAuthStatusHeaderEl.innerHTML = '<a href="/login" class="text-gray-700 hover:text-red-600 font-semibold">Đăng nhập</a>';
            }
        }
    }

    // --- Khởi tạo Trang Checkout ---
    document.addEventListener('DOMContentLoaded', () => {
        // Gán các phần tử DOM chính
        checkoutLoadingMessageEl = document.getElementById('checkoutLoadingMessage');
        checkoutFormEl = document.getElementById('checkoutForm');
        checkoutOrderSummaryItemsEl = document.getElementById('checkoutOrderSummaryItems');
        summaryTotalQuantityCheckoutEl = document.getElementById('summaryTotalQuantityCheckout');
        summarySubtotalCheckoutEl = document.getElementById('summarySubtotalCheckout');
        summaryGrandTotalCheckoutEl = document.getElementById('summaryGrandTotalCheckout');
        placeOrderButtonEl = document.getElementById('placeOrderButton');
        checkoutFormMessageEl = document.getElementById('checkoutFormMessage');
        guestInfoMessageEl = document.getElementById('guestInfoMessage');
        cartItemCountHeaderEl = document.getElementById('cartItemCountHeader');
        userAuthStatusHeaderEl = document.getElementById('userAuthStatusHeader');
        toast = document.getElementById('toast');
        toastMessage = document.getElementById('toastMessage');

        // Gán các phần tử input
        customerNameInput = document.getElementById('customerName');
        customerPhoneInput = document.getElementById('customerPhone');
        customerEmailInput = document.getElementById('customerEmail');
        addressNumberInput = document.getElementById('addressNumber');
        addressStreetInput = document.getElementById('addressStreet');
        addressWardInput = document.getElementById('addressWard');
        addressDistrictInput = document.getElementById('addressDistrict');
        addressCityInput = document.getElementById('addressCity');
        orderTitleInput = document.getElementById('orderTitle');

        // Gán các phần tử hiển thị lỗi
        customerNameErrorEl = document.getElementById('customerNameError');
        customerPhoneErrorEl = document.getElementById('customerPhoneError');
        customerEmailErrorEl = document.getElementById('customerEmailError');
        addressNumberErrorEl = document.getElementById('addressNumberError');
        addressStreetErrorEl = document.getElementById('addressStreetError');
        addressWardErrorEl = document.getElementById('addressWardError');
        addressDistrictErrorEl = document.getElementById('addressDistrictError');
        addressCityErrorEl = document.getElementById('addressCityError');


        // <<< SỬA LỖI 1: DI CHUYỂN LOGIC addEventListener VÀO ĐÂY
        // Gắn listener cho form CHỈ SAU KHI DOM đã tải
        if (checkoutFormEl) {
            checkoutFormEl.addEventListener('submit', async function(event) {
                event.preventDefault(); // Ngăn chặn submit form HTML
                clearErrors();

                if (placeOrderButtonEl) { placeOrderButtonEl.disabled = true; placeOrderButtonEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...'; }

                const token = getToken();

                // <<< SỬA LỖI 2: XÓA KHỐI if (!token) ...
                // Logic cũ: if(!token) { redirect to login; } -> SAI
                // Logic mới: Tiếp tục thực hiện, API sẽ xử lý khách hoặc người dùng

                // Lấy giá trị từ các input và trim()
                const customerName = customerNameInput.value.trim();
                const customerPhone = customerPhoneInput.value.trim();
                const customerEmail = customerEmailInput.value.trim();
                const addressNumber = addressNumberInput.value.trim();
                const addressStreet = addressStreetInput.value.trim();
                const addressWard = addressWardInput.value.trim();
                const addressDistrict = addressDistrictInput.value.trim();
                const addressCity = addressCityInput.value.trim();
                const orderTitle = orderTitleInput.value.trim();

                let hasClientError = false;

                // Client-side validation
                if (!customerName) { displayError(customerNameErrorEl, 'Tên người nhận không được để trống.'); hasClientError = true; } else { displayError(customerNameErrorEl, ''); }
                if (!customerPhone) { displayError(customerPhoneErrorEl, 'Số điện thoại không được để trống.'); hasClientError = true; } else { displayError(customerPhoneErrorEl, ''); }
                if (customerEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(customerEmail)) { displayError(customerEmailErrorEl, 'Email không hợp lệ.'); hasClientError = true; } else { displayError(customerEmailErrorEl, ''); }
                if (!addressNumber) { displayError(addressNumberErrorEl, 'Số nhà không được để trống.'); hasClientError = true; } else { displayError(addressNumberErrorEl, ''); }
                if (!addressStreet) { displayError(addressStreetErrorEl, 'Tên đường không được để trống.'); hasClientError = true; } else { displayError(addressStreetErrorEl, ''); }
                if (!addressWard) { displayError(addressWardErrorEl, 'Phường/Xã không được để trống.'); hasClientError = true; } else { displayError(addressWardErrorEl, ''); }
                if (!addressDistrict) { displayError(addressDistrictErrorEl, 'Quận/Huyện không được để trống.'); hasClientError = true; } else { displayError(addressDistrictErrorEl, ''); }
                if (!addressCity) { displayError(addressCityErrorEl, 'Tỉnh/Thành phố không được để trống.'); hasClientError = true; } else { displayError(addressCityErrorEl, ''); }

                if (hasClientError) {
                    showToast("Vui lòng điền đầy đủ và chính xác thông tin bắt buộc.", false);
                    if (placeOrderButtonEl) { placeOrderButtonEl.disabled = false; placeOrderButtonEl.innerHTML = 'XÁC NHẬN ĐẶT HÀNG'; }
                    return;
                }

                // Construct OrderRequest object
                const orderRequest = {
                    customerName: customerName,
                    customerPhone: customerPhone,
                    customerEmail: customerEmail || null,
                    shippingAddress: {
                        number: addressNumber,
                        street: addressStreet,
                        ward: addressWard,
                        district: addressDistrict,
                        city: addressCity
                    },
                    title: orderTitle || null,
                    // guestCartId chỉ được gửi nếu user KHÔNG đăng nhập (không có token)
                    guestCartId: token ? null : getGuestCartId()
                };

                console.log("CheckoutPage - Placing order with request:", JSON.stringify(orderRequest));

                try {
                    // <<< SỬA LỖI 3: Đặt hàng (POST) không "requiresAuth"
                    // vì guest cũng có thể đặt. Hàm makeApiCall sẽ tự động
                    // thêm token nếu nó tồn tại.
                    const response = await makeApiCall(API_ORDER_URL, 'POST', orderRequest, false); // requiresAuth: FALSE

                    const contentType = response.headers.get("content-type");
                    let responseData;

                    if (contentType && contentType.includes("application/json")) {
                        responseData = await response.json();
                    } else {
                        const textResponse = await response.text();
                        console.error("Phản hồi đặt hàng không phải JSON. Status:", response.status, "Text:", textResponse.substring(0, 500));
                        throw new Error(`Phản hồi không hợp lệ từ server (Status: ${response.status}). Chi tiết: ${textResponse.substring(0,100)}...`);
                    }
                    console.log("CheckoutPage - Place order response data (JSON):", responseData);

                    if (responseData.status === 201 && responseData.data && responseData.data.id) {
                        showToast("Đặt hàng thành công! Cảm ơn bạn.", true);
                        removeGuestCartId(); // Xóa guest cart ID
                        if (cartItemCountHeaderEl) cartItemCountHeaderEl.textContent = '0';

                        const orderId = responseData.data.id;
                        setTimeout(() => { window.location.href = `/order-confirmation?orderId=${orderId}`; }, 1500);
                    } else {
                        showToast(`Lỗi đặt hàng: ${responseData.message || 'Không thành công'} (Mã lỗi: ${responseData.status || response.status})`, false);
                        if(checkoutFormMessageEl) checkoutFormMessageEl.textContent = responseData.message || 'Lỗi không xác định từ server.';
                    }
                } catch (error) {
                    if (error.message !== 'Unauthorized' && error.message !== 'Forbidden' && error.message !== 'NO_TOKEN') {
                        console.error("Lỗi khi đặt hàng:", error);
                        showToast(`Lỗi kết nối hoặc xử lý: ${error.message}`, false);
                        if(checkoutFormMessageEl) checkoutFormMessageEl.textContent = `Lỗi: ${error.message}`;
                    }
                } finally {
                    if (placeOrderButtonEl) { placeOrderButtonEl.disabled = false; placeOrderButtonEl.innerHTML = 'XÁC NHẬN ĐẶT HÀNG'; }
                }
            });
        }
        // <<< KẾT THÚC DI CHUYỂN

        // Chạy các hàm khởi tạo
        updateUserAuthStatusOnHeader();
        loadCartSummaryForCheckout();
        prefillShippingForm();
    });
</script>
</body>
</html>