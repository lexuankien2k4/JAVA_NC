<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập & Đăng ký</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="tel"] /* Thay đổi type cho phone */ {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            word-wrap: break-word;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .toggle-form {
            text-align: center;
            margin-top: 20px;
        }

        .toggle-form a {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }

        .toggle-form a:hover {
            text-decoration: underline;
        }

        .hidden-form {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="login-form-container">
        <h2>Đăng nhập</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginUsername">Tên đăng nhập:</label>
                <input type="text" id="loginUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Mật khẩu:</label>
                <input type="password" id="loginPassword" name="password" required>
            </div>
            <button type="submit">Đăng nhập</button>
            <div id="loginMessage" class="message" style="display: none;"></div>
        </form>
        <div class="toggle-form">
            <p>Chưa có tài khoản? <a onclick="toggleForms()">Đăng ký ngay</a></p>
        </div>
    </div>

    <div id="register-form-container" class="hidden-form">
        <h2>Đăng ký</h2>
        <form id="registerForm">
            <div class="form-group">
                <label for="registerUsername">Tên đăng nhập:</label>
                <input type="text" id="registerUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="registerFirstName">Tên:</label>
                <input type="text" id="registerFirstName" name="firstName" required>
            </div>
            <div class="form-group">
                <label for="registerLastName">Họ:</label>
                <input type="text" id="registerLastName" name="lastName" required>
            </div>
            <div class="form-group">
                <label for="registerEmail">Email:</label>
                <input type="email" id="registerEmail" name="email" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">Mật khẩu:</label>
                <input type="password" id="registerPassword" name="password" required>
            </div>
            <div class="form-group">
                <label for="registerPhone">Số điện thoại:</label>
                <input type="tel" id="registerPhone" name="phone"> {/* Changed type to tel for better mobile UX */}
            </div>
            <button type="submit">Đăng ký</button>
            <div id="registerMessage" class="message" style="display: none;"></div>
        </form>
        <div class="toggle-form">
            <p>Đã có tài khoản? <a onclick="toggleForms()">Đăng nhập</a></p>
        </div>
    </div>
</div>

<script>
    const loginFormContainer = document.getElementById('login-form-container');
    const registerFormContainer = document.getElementById('register-form-container');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginMessageDiv = document.getElementById('loginMessage');
    const registerMessageDiv = document.getElementById('registerMessage');

    const API_BASE_URL = '/api/v1/auth'; // Đảm bảo khớp với backend của bạn

    function toggleForms() {
        loginFormContainer.classList.toggle('hidden-form');
        registerFormContainer.classList.toggle('hidden-form');
        hideMessages();
    }

    function displayMessage(element, message, isSuccess) {
        element.textContent = message;
        element.className = 'message ' + (isSuccess ? 'success' : 'error');
        element.style.display = 'block';
        console.log(`Message displayed (${isSuccess ? 'SUCCESS' : 'ERROR'}):`, message);
    }

    function hideMessages() {
        loginMessageDiv.style.display = 'none';
        loginMessageDiv.textContent = '';
        registerMessageDiv.style.display = 'none';
        registerMessageDiv.textContent = '';
    }

    // Xử lý Đăng ký
    registerForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        hideMessages();
        console.log('Register form submitted');

        const formData = new FormData(registerForm);
        const phoneString = formData.get('phone');
        let phoneNumber = null;
        if (phoneString && phoneString.trim() !== "") {
            const parsedPhone = parseInt(phoneString.trim(), 10);
            if (!isNaN(parsedPhone)) {
                phoneNumber = parsedPhone;
            } else {
                displayMessage(registerMessageDiv, 'Số điện thoại không hợp lệ.', false);
                return; // Ngăn không gửi nếu SĐT không hợp lệ
            }
        }

        const userData = {
            username: formData.get('username'),
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            password: formData.get('password'),
            phone: phoneNumber // Gửi số đã parse hoặc null
        };
        console.log('User data for registration:', JSON.stringify(userData));

        try {
            const response = await fetch(`${API_BASE_URL}/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData),
            });
            console.log('Registration response status:', response.status);

            let responseData;
            try {
                // Kiểm tra xem response có body không trước khi parse
                if (response.headers.get("content-length") === "0" || response.status === 204) {
                    responseData = {}; // Hoặc xử lý theo cách khác nếu không có body
                } else {
                    responseData = await response.json();
                }
                console.log('Registration response data:', responseData);
            } catch (e) {
                const textResponse = await response.text();
                console.error('Registration response is not JSON. Text response:', textResponse);
                displayMessage(registerMessageDiv, `Lỗi từ server: ${response.statusText} (Không phải JSON). Chi tiết: ${textResponse.substring(0,100)}...`, false);
                return;
            }

            if (response.status === 201) { // Created
                // Sử dụng responseData.userName từ UserResponse DTO
                displayMessage(registerMessageDiv, `Đăng ký thành công! Chào mừng ${responseData.userName || userData.username}. Bạn có thể đăng nhập ngay.`, true);
                registerForm.reset();
            } else {
                // Cố gắng lấy thông điệp lỗi từ backend
                // Giả sử backend trả về lỗi có dạng { "message": "Some error" } hoặc { "error": "Some error"}
                const errorMessage = responseData.message || responseData.error || response.statusText || 'Lỗi không xác định từ server.';
                displayMessage(registerMessageDiv, `Lỗi đăng ký: ${errorMessage} (Code: ${response.status})`, false);
            }

        } catch (error) {
            console.error('Network or JS error during registration:', error);
            displayMessage(registerMessageDiv, 'Đã xảy ra lỗi kết nối hoặc xử lý. Vui lòng thử lại.', false);
        }
    });

    // Xử lý Đăng nhập
    loginForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        hideMessages();
        console.log('Login form submitted');

        const formData = new FormData(loginForm);
        const loginData = {
            username: formData.get('username'),
            password: formData.get('password'),
        };
        console.log('Login data:', JSON.stringify(loginData));

        try {
            const response = await fetch(`${API_BASE_URL}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(loginData),
            });
            console.log('Login response status:', response.status);

            let responseData;
            try {
                 if (response.headers.get("content-length") === "0" || response.status === 204) {
                    responseData = {};
                } else {
                    responseData = await response.json();
                }
                console.log('Login response data:', responseData);
            } catch (e) {
                const textResponse = await response.text();
                console.error('Login response is not JSON. Text response:', textResponse);
                displayMessage(loginMessageDiv, `Lỗi từ server: ${response.statusText} (Không phải JSON). Chi tiết: ${textResponse.substring(0,100)}...`, false);
                return;
            }

            if (response.ok) { // status 200-299
                // Sử dụng responseData.userResponse.userName từ AuthenticationResponse DTO
                const greetingName = responseData.userResponse ? responseData.userResponse.userName : loginData.username;
                displayMessage(loginMessageDiv, `Đăng nhập thành công! Chào mừng ${greetingName}.`, true);
                loginForm.reset();
                console.log('Access Token:', responseData.accessToken);
                console.log('Refresh Token:', responseData.refreshToken);
                // Ví dụ: localStorage.setItem('accessToken', responseData.accessToken);
                // Ví dụ: window.location.href = '/trang-duoc-bao-ve';
            } else {
                const errorMessage = responseData.message || responseData.error || response.statusText || 'Sai tên đăng nhập hoặc mật khẩu.';
                displayMessage(loginMessageDiv, `Lỗi đăng nhập: ${errorMessage} (Code: ${response.status})`, false);
            }
        } catch (error) {
            console.error('Network or JS error during login:', error);
            displayMessage(loginMessageDiv, 'Đã xảy ra lỗi kết nối hoặc xử lý. Vui lòng thử lại.', false);
        }
    });
</script>

</body>
</html>
